<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MyEMDR V5</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MyEMDR">

<style>
  :root{
    --bgA:#ffd6ee;
    --bgB:#cfefff;
    --bgC:#fff0b8;

    --card:#ffffffef;
    --stroke:#ff76b8;
    --stroke2:#5cc8ff;

    --ink:#242424;
    --muted:#5a5a5a;

    --shadow:0 14px 32px rgba(0,0,0,.10);

    --good:#2fd17a;
    --warn:#f6c24a;
    --stop:#ff5a74;
  }
  *{box-sizing:border-box}
  body{
    margin:18px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--ink);
    max-width:1100px;
    background:
      radial-gradient(900px 550px at 5% 0%, var(--bgB), transparent 55%),
      radial-gradient(900px 650px at 105% 0%, var(--bgA), transparent 60%),
      radial-gradient(700px 500px at 50% 110%, var(--bgC), transparent 60%),
      linear-gradient(180deg,#ffffff,#ffe9f6 55%,#e8f7ff);
  }
  .topbar{
    display:flex; justify-content:space-between; gap:12px;
    flex-wrap:wrap; margin-bottom:12px; align-items:flex-start;
  }
  h1{margin:0;font-size:20px}
  .sub{font-size:12px;color:var(--muted);line-height:1.35;margin-top:4px;max-width:720px}
  .badge{
    padding:8px 12px;border-radius:999px;border:2px solid var(--stroke2);
    background:#fff;box-shadow:var(--shadow);font-size:12px;color:#333;
  }

  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr}}

  .card{
    background:var(--card);
    border:2px solid var(--stroke);
    border-radius:22px;
    padding:16px;
    box-shadow:var(--shadow);
    backdrop-filter:blur(7px);
  }
  .card.alt{border-color:var(--stroke2)}
  h3{margin:0 0 10px;font-size:15px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,button,textarea{
    width:100%;
    padding:11px 12px;
    border-radius:16px;
    border:2px solid #eee;
    background:#fff;
    font-size:14px;
  }
  textarea{min-height:120px;resize:vertical}
  input[type=range]{padding:10px}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .btnrow button{flex:1}
  button{cursor:pointer;font-weight:850;letter-spacing:.25px}
  button:disabled{opacity:.55;cursor:not-allowed}
  .good{border-color:#b8f3d1;background:linear-gradient(135deg,#f0fff6,#fff)}
  .warn{border-color:#ffe6a6;background:linear-gradient(135deg,#fff7e1,#fff)}
  .stop{border-color:#ffc2cb;background:linear-gradient(135deg,#fff0f2,#fff)}
  .primary{border-color:#111}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status{
    margin-top:12px;
    padding:11px 12px;
    border-radius:16px;
    border:2px dashed var(--stroke);
    background:#fff;
    font-size:13px;
    line-height:1.35;
  }
  .small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

  .meterWrap{
    margin-top:12px;
    border:2px solid #eee;
    border-radius:16px;
    background:#fff;
    padding:10px 12px;
  }
  .meterTop{
    display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
    font-size:12px;color:var(--muted);margin-bottom:8px;
  }
  .bar{
    width:100%;
    height:12px;
    border-radius:999px;
    background:linear-gradient(90deg,#f2f2f2,#f7f7f7);
    overflow:hidden;
    border:1px solid #eee;
  }
  .bar>div{
    height:100%;
    width:0%;
    border-radius:999px;
    background:linear-gradient(90deg,var(--stroke2),var(--stroke));
    transition:width .25s ease;
  }

  /* Visual bilateral cue */
  .vizWrap{
    margin-top:12px;
    padding:14px;
    border-radius:18px;
    border:2px solid #eee;
    background:#fff;
  }
  .vizTrack{
    position:relative;
    height:34px;
    border-radius:999px;
    background:linear-gradient(90deg,#fff0f8,#eef9ff);
    border:1px solid #eee;
    overflow:hidden;
  }
  .vizDot{
    position:absolute;
    top:50%;
    width:22px;
    height:22px;
    border-radius:999px;
    transform:translateY(-50%);
    background:radial-gradient(circle at 35% 35%, #fff, rgba(255,255,255,0) 55%),
               linear-gradient(135deg, var(--stroke2), var(--stroke));
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    left:6px;
    transition:left .18s ease;
  }
  .pill{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #eee;
    background:#fff;
    font-size:12px;
    color:#444;
  }
</style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>MyEMDR <span class="pill">V5</span></h1>
      <div class="sub">
        Personal regulation audio mixer: grounding voice + soft alternating beeps. Use as a calming tool (not a substitute for professional care).
      </div>
    </div>
    <div class="badge">Installable • Offline • Best export on desktop Chrome/Edge</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h3>Voice source</h3>

      <div class="row">
        <div>
          <label>Mode</label>
          <select id="voiceMode">
            <option value="upload" selected>Upload voice audio (best for recording/export)</option>
            <option value="tts">TTS preview (playback only)</option>
          </select>
          <div class="small">TTS is for quick testing. Browsers usually cannot record/export TTS cleanly.</div>
        </div>
        <div>
          <label>Preset</label>
          <select id="preset">
            <option value="calm" selected>Calm</option>
            <option value="reset">Fast Reset</option>
            <option value="work">Work Mode</option>
          </select>
        </div>
      </div>

      <div id="uploadBlock">
        <label>Upload grounding voice file (MP3/M4A recommended on iPad)</label>
        <input type="file" id="voiceFile" accept="audio/*">
        <div class="btnrow" style="margin-top:10px;">
          <button class="primary" id="btnLoad">Load Voice</button>
          <button id="btnTestBeeps">Test Beeps</button>
        </div>
        <div class="status" id="loadStatus"><strong>Status:</strong> No voice loaded yet.</div>
      </div>

      <div id="ttsBlock" style="display:none;">
        <label>Paste your script for TTS preview</label>
        <textarea id="ttsText" placeholder="Type or paste a short grounding script here..."></textarea>

        <div class="row">
          <div>
            <label>TTS voice</label>
            <select id="ttsVoice"></select>
          </div>
          <div>
            <label>TTS rate</label>
            <input id="ttsRate" type="range" min="0.7" max="1.2" step="0.05" value="0.95">
          </div>
        </div>

        <div class="btnrow" style="margin-top:10px;">
          <button class="good" id="btnSpeak">Play TTS + Beeps</button>
          <button class="stop" id="btnStopTTS" disabled>Stop</button>
        </div>
        <div class="status" id="ttsStatus"><strong>Status:</strong> Ready for TTS preview.</div>
      </div>

      <h3 style="margin-top:16px;">Play and export</h3>
      <div class="btnrow">
        <button class="good" id="btnPlay" disabled>Play Mixed</button>
        <button class="stop" id="btnStop" disabled>Stop</button>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button class="warn" id="btnRecord" disabled>Record Mixed</button>
        <button id="btnDownloadLast" disabled>Download Last Recording</button>
      </div>

      <div class="meterWrap">
        <div class="meterTop">
          <div><strong>Recording progress</strong></div>
          <div id="timeReadout">00:00 / 00:00</div>
        </div>
        <div class="bar"><div id="barFill"></div></div>
        <div class="small">
          If download doesn’t appear on iPad, open this site on a desktop (Chrome/Edge) and export there.
        </div>
      </div>

      <div class="vizWrap">
        <div class="row">
          <div>
            <label>Visual bilateral cue</label>
            <select id="vizToggle">
              <option value="on" selected>On</option>
              <option value="off">Off</option>
            </select>
            <div class="small">A subtle dot moves left/right in sync with beeps.</div>
          </div>
          <div>
            <label>Filename</label>
            <input id="fileName" value="myemdr-mix-v5.webm">
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="vizTrack">
            <div class="vizDot" id="vizDot"></div>
          </div>
        </div>
      </div>

      <div class="status" id="runStatus"><strong>Status:</strong> Idle.</div>
    </div>

    <!-- RIGHT -->
    <div class="card alt">
      <h3>Sound settings</h3>

      <div class="row">
        <div>
          <label>Beep pace (seconds per side)</label>
          <select id="pace">
            <option value="1.3">Slow</option>
            <option value="1.0" selected>Medium</option>
            <option value="0.7">Brisk</option>
          </select>
        </div>
        <div>
          <label>Beep tone (Hz)</label>
          <input id="freq" type="number" value="520" min="80" max="1200">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Beep volume</label>
          <input id="beepVol" type="range" min="0" max="0.2" step="0.005" value="0.11">
          <div class="small">Testing tip: temporarily raise to 0.14–0.16 to confirm it’s audible.</div>
        </div>
        <div>
          <label>Ducking under voice</label>
          <select id="duck">
            <option value="1.00">Off</option>
            <option value="0.80">Light</option>
            <option value="0.60" selected>Medium</option>
            <option value="0.40">Strong</option>
          </select>
          <div class="small">Keeps beeps behind the voice.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fade in/out (seconds)</label>
          <select id="fade">
            <option value="0">Off</option>
            <option value="2">2</option>
            <option value="4" selected>4</option>
            <option value="6">6</option>
          </select>
        </div>
        <div>
          <label>Beep style</label>
          <select id="beepType">
            <option value="sine" selected>Soft</option>
            <option value="triangle">Gentle</option>
          </select>
        </div>
      </div>

      <h3 style="margin-top:16px;">Notes</h3>
      <div class="small">
        • Keep beeps quiet for regulation work.<br>
        • If beeps feel activating, slow the pace (1.3) and lower the tone (440).<br>
        • If you feel overwhelmed, stop the track and switch to simple grounding (breathing + orienting to your space).
      </div>
    </div>
  </div>

<script>
/* =========================================================
   MyEMDR V5
   - Upload voice mixing + export (best desktop Chrome/Edge)
   - TTS preview + beeps (playback only)
   - Visual bilateral cue synchronized with beeps
   - PWA hooks via manifest + service worker (registered below)
   ========================================================= */

let ctx = null;
let chosenFile = null;
let voiceBuffer = null;

let voiceNode = null;
let gainVoice = null;
let gainBeeps = null;

let running = false;
let tickTimer = null;

// recording
let mediaDest = null;
let recorder = null;
let recChunks = [];
let lastRecordingUrl = null;

// progress UI
let progressTimer = null;
let recordStartMs = 0;
let recordTotalMs = 0;

// bilateral visual
let side = 0; // 0=left,1=right

const $ = (id) => document.getElementById(id);
const setRunStatus = (html) => $("runStatus").innerHTML = html;
const setLoadStatus = (html) => $("loadStatus").innerHTML = html;

function ensureCtx(){
  if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  return ctx;
}

function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function setProgress(elapsedMs, totalMs){
  const pct = totalMs > 0 ? Math.min(100, (elapsedMs/totalMs)*100) : 0;
  $("barFill").style.width = pct.toFixed(1) + "%";
  $("timeReadout").textContent = `${fmtTime(elapsedMs/1000)} / ${fmtTime(totalMs/1000)}`;
}

function stopProgress(){
  if (progressTimer) clearInterval(progressTimer);
  progressTimer = null;
  setProgress(0, recordTotalMs || 0);
}

function startProgress(totalMs){
  recordStartMs = Date.now();
  recordTotalMs = totalMs;
  setProgress(0, totalMs);
  if (progressTimer) clearInterval(progressTimer);
  progressTimer = setInterval(()=>{
    const elapsed = Date.now() - recordStartMs;
    setProgress(elapsed, totalMs);
  }, 250);
}

function vizMove(){
  if ($("vizToggle").value !== "on") return;
  const dot = $("vizDot");
  // 6px left padding; right ~ calc(100% - dot - 6px)
  dot.style.left = side ? "calc(100% - 28px)" : "6px";
}

function stopAll(){
  running = false;
  clearTimeout(tickTimer);
  tickTimer = null;

  try { voiceNode?.stop(); } catch {}
  voiceNode = null;

  if (recorder && recorder.state !== "inactive") {
    try { recorder.stop(); } catch {}
  }
  recorder = null;

  stopProgress();

  $("btnStop").disabled = true;
  $("btnPlay").disabled = !voiceBuffer;
  $("btnRecord").disabled = !voiceBuffer;

  setRunStatus("<strong>Status:</strong> Stopped.");
}

function applyFade(gainNode, durationSec){
  const fade = Number($("fade").value);
  if (!fade || fade <= 0) return;
  const c = ensureCtx();
  const now = c.currentTime;

  gainNode.gain.setValueAtTime(0.0001, now);
  gainNode.gain.exponentialRampToValueAtTime(1.0, now + fade);

  const endAt = now + durationSec;
  gainNode.gain.setValueAtTime(1.0, Math.max(now + fade, endAt - fade));
  gainNode.gain.exponentialRampToValueAtTime(0.0001, endAt);
}

function makeBeep(pan){
  const c = ensureCtx();
  const osc = c.createOscillator();
  const g = c.createGain();
  const panNode = c.createStereoPanner();

  panNode.pan.value = pan;
  osc.type = $("beepType").value;
  osc.frequency.value = Number($("freq").value);

  const t0 = c.currentTime;
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(1.0, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.12);

  osc.connect(g).connect(panNode).connect(gainBeeps);
  osc.start();
  osc.stop(t0 + 0.15);
}

function startBeeps(durationSec){
  const intervalMs = Number($("pace").value) * 1000;
  const start = Date.now();
  side = 0;

  const tick = () => {
    if (!running) return;

    // left/right beep
    makeBeep(side ? 1 : -1);
    vizMove();
    side = 1 - side;

    if (Date.now() - start < durationSec * 1000) {
      tickTimer = setTimeout(tick, intervalMs);
    }
  };
  tick();
}

function applyPreset(name){
  if (name === "calm"){
    $("pace").value = "1.3";
    $("freq").value = "520";
    $("duck").value = "0.60";
    $("beepVol").value = "0.11";
    $("fade").value = "4";
    $("beepType").value = "sine";
  } else if (name === "reset"){
    $("pace").value = "0.7";
    $("freq").value = "560";
    $("duck").value = "0.80";
    $("beepVol").value = "0.12";
    $("fade").value = "2";
    $("beepType").value = "sine";
  } else if (name === "work"){
    $("pace").value = "1.0";
    $("freq").value = "440";
    $("duck").value = "0.60";
    $("beepVol").value = "0.10";
    $("fade").value = "4";
    $("beepType").value = "triangle";
  }
}

/* ========= Upload Voice ========= */

$("voiceFile").addEventListener("change", (e)=>{
  chosenFile = e.target.files?.[0] || null;
  voiceBuffer = null;
  $("btnPlay").disabled = true;
  $("btnRecord").disabled = true;

  if (!chosenFile){
    setLoadStatus("<strong>Status:</strong> No file selected.");
    return;
  }
  setLoadStatus(`<strong>Status:</strong> Selected <strong>${chosenFile.name}</strong>. Tap <strong>Load Voice</strong>.`);
});

$("btnLoad").addEventListener("click", async ()=>{
  if (!chosenFile) return alert("Choose a voice file first.");
  const c = ensureCtx();
  await c.resume?.();

  try{
    const arr = await chosenFile.arrayBuffer();
    voiceBuffer = await c.decodeAudioData(arr);

    $("btnPlay").disabled = false;
    $("btnRecord").disabled = false;

    setLoadStatus(`<strong>Status:</strong> Loaded. Duration <strong>${voiceBuffer.duration.toFixed(1)}s</strong>.`);
    setRunStatus("<strong>Status:</strong> Ready.");
  }catch(err){
    console.error(err);
    voiceBuffer = null;
    $("btnPlay").disabled = true;
    $("btnRecord").disabled = true;
    setLoadStatus("<strong>Status:</strong> Could not decode. Try MP3 or M4A.");
    alert("Decode failed in this browser. MP3/M4A is most reliable on iPad.");
  }
});

$("btnTestBeeps").addEventListener("click", async ()=>{
  const c = ensureCtx();
  await c.resume?.();

  gainBeeps = c.createGain();
  gainBeeps.gain.value = Math.max(0.10, Number($("beepVol").value));
  gainBeeps.connect(c.destination);

  let count = 0;
  side = 0;
  const go = () => {
    if (count >= 6) return;
    makeBeep(side ? 1 : -1);
    vizMove();
    side = 1 - side;
    count++;
    setTimeout(go, 600);
  };
  go();

  setRunStatus("<strong>Status:</strong> Testing beeps.");
});

function buildPlaybackGraph(){
  const c = ensureCtx();
  gainVoice = c.createGain();
  gainBeeps = c.createGain();

  const beepBase = Number($("beepVol").value);
  const duck = Number($("duck").value);
  gainBeeps.gain.value = beepBase * duck;

  gainVoice.connect(c.destination);
  gainBeeps.connect(c.destination);

  applyFade(gainVoice, voiceBuffer.duration);
}

$("btnPlay").addEventListener("click", async ()=>{
  if (!voiceBuffer) return alert("Load voice first.");
  const c = ensureCtx();
  await c.resume?.();

  stopAll();
  buildPlaybackGraph();

  voiceNode = c.createBufferSource();
  voiceNode.buffer = voiceBuffer;
  voiceNode.connect(gainVoice);

  running = true;
  $("btnStop").disabled = false;
  $("btnPlay").disabled = true;
  $("btnRecord").disabled = true;

  setRunStatus("<strong>Status:</strong> Playing mixed track.");
  voiceNode.start();
  startBeeps(voiceBuffer.duration);

  voiceNode.onended = () => {
    stopAll();
    setRunStatus("<strong>Status:</strong> Finished playback.");
  };
});

$("btnStop").addEventListener("click", stopAll);

$("btnRecord").addEventListener("click", async ()=>{
  if (!voiceBuffer) return alert("Load voice first.");
  const c = ensureCtx();
  await c.resume?.();

  stopAll();

  // Build record graph
  gainVoice = c.createGain();
  gainBeeps = c.createGain();

  const beepBase = Number($("beepVol").value);
  const duck = Number($("duck").value);
  gainBeeps.gain.value = beepBase * duck;

  mediaDest = c.createMediaStreamDestination();
  gainVoice.connect(mediaDest);
  gainBeeps.connect(mediaDest);

  // monitor
  gainVoice.connect(c.destination);
  gainBeeps.connect(c.destination);

  applyFade(gainVoice, voiceBuffer.duration);

  // Recorder
  recChunks = [];
  try{
    recorder = new MediaRecorder(mediaDest.stream);
  }catch(err){
    console.error(err);
    alert("Recording not supported here. For reliable export, use desktop Chrome/Edge.");
    setRunStatus("<strong>Status:</strong> Recording not supported in this browser.");
    return;
  }

  recorder.ondataavailable = (e)=>{ if (e.data?.size) recChunks.push(e.data); };
  recorder.onstop = ()=>{
    const blob = new Blob(recChunks, { type: recorder.mimeType || "audio/webm" });
    if (lastRecordingUrl) URL.revokeObjectURL(lastRecordingUrl);
    lastRecordingUrl = URL.createObjectURL(blob);
    $("btnDownloadLast").disabled = false;
    stopProgress();
    setRunStatus("<strong>Status:</strong> Recording complete. Tap <strong>Download Last Recording</strong>.");
  };

  // Start
  voiceNode = c.createBufferSource();
  voiceNode.buffer = voiceBuffer;
  voiceNode.connect(gainVoice);

  running = true;
  $("btnStop").disabled = false;
  $("btnPlay").disabled = true;
  $("btnRecord").disabled = true;

  setRunStatus("<strong>Status:</strong> Recording… keep this tab open.");
  startProgress(voiceBuffer.duration * 1000);

  recorder.start();
  voiceNode.start();
  startBeeps(voiceBuffer.duration);

  setTimeout(()=>{
    try { recorder.stop(); } catch {}
    running = false;
    $("btnStop").disabled = true;
    $("btnPlay").disabled = false;
    $("btnRecord").disabled = false;
  }, voiceBuffer.duration * 1000 + 250);
});

$("btnDownloadLast").addEventListener("click", ()=>{
  if (!lastRecordingUrl) return alert("No recording available yet.");
  const name = ($("fileName").value || "myemdr-mix-v5.webm").trim();
  const a = document.createElement("a");
  a.href = lastRecordingUrl;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setRunStatus("<strong>Status:</strong> Download triggered. Check Downloads/Files.");
});

/* ========= TTS Preview ========= */

function populateVoices(){
  const sel = $("ttsVoice");
  const voices = window.speechSynthesis?.getVoices?.() || [];
  sel.innerHTML = "";
  voices.forEach((v, i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });
}

if ("speechSynthesis" in window){
  populateVoices();
  window.speechSynthesis.onvoiceschanged = populateVoices;
}

function stopTTS(){
  try { window.speechSynthesis?.cancel(); } catch {}
  running = false;
  clearTimeout(tickTimer);
  tickTimer = null;
  $("btnStopTTS").disabled = true;
  $("btnSpeak").disabled = false;
  setRunStatus("<strong>Status:</strong> TTS stopped.");
  $("ttsStatus").innerHTML = "<strong>Status:</strong> Ready for TTS preview.";
}

$("btnSpeak").addEventListener("click", async ()=>{
  if (!("speechSynthesis" in window)) return alert("TTS not available in this browser.");
  const text = ($("ttsText").value || "").trim();
  if (!text) return alert("Paste a short script first.");

  const c = ensureCtx();
  await c.resume?.();

  // Beeps bus to speakers
  gainBeeps = c.createGain();
  gainBeeps.gain.value = Number($("beepVol").value) * Number($("duck").value);
  gainBeeps.connect(c.destination);

  // Speak
  const voices = window.speechSynthesis.getVoices();
  const idx = Number($("ttsVoice").value || 0);
  const utter = new SpeechSynthesisUtterance(text);
  if (voices[idx]) utter.voice = voices[idx];
  utter.rate = Number($("ttsRate").value || 0.95);

  running = true;
  $("btnSpeak").disabled = true;
  $("btnStopTTS").disabled = false;

  setRunStatus("<strong>Status:</strong> Playing TTS + beeps (preview).");
  $("ttsStatus").innerHTML = "<strong>Status:</strong> Speaking…";

  // crude duration estimate: ~140 wpm baseline, scaled by rate
  const words = text.split(/\s+/).filter(Boolean).length;
  const estSec = Math.max(10, (words / (140 * utter.rate)) * 60);

  startBeeps(estSec);
  vizMove();
  window.speechSynthesis.speak(utter);

  utter.onend = ()=>{
    stopTTS();
    setRunStatus("<strong>Status:</strong> Finished TTS preview.");
  };
  utter.onerror = ()=>{
    stopTTS();
    setRunStatus("<strong>Status:</strong> TTS error (stopped).");
  };
});

$("btnStopTTS").addEventListener("click", stopTTS);

/* ========= Mode switching + presets ========= */

$("voiceMode").addEventListener("change", ()=>{
  const mode = $("voiceMode").value;
  $("uploadBlock").style.display = (mode === "upload") ? "" : "none";
  $("ttsBlock").style.display = (mode === "tts") ? "" : "none";

  // Upload controls
  $("btnPlay").disabled = (mode !== "upload") || !voiceBuffer;
  $("btnRecord").disabled = (mode !== "upload") || !voiceBuffer;

  // Stop any playing audio
  stopAll();
  stopTTS();
});

$("preset").addEventListener("change", ()=>{
  applyPreset($("preset").value);
});

applyPreset("calm");

/* ========= PWA service worker ========= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  });
}
</script>
</body>
</html>
